FROM ubuntu:24.04

ARG PHP_VERSION=8.3

ENV TZ=Asia/hong_kong \
    DEBIAN_FRONTEND=noninteractive

ENV PHP_VERSION ${PHP_VERSION}

RUN apt-get update && apt-get install -y locales && rm -rf /var/lib/apt/lists/* \
	&& localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8
ENV LANG en_US.utf8

RUN apt-get update -y && apt-get install -y software-properties-common && add-apt-repository ppa:ondrej/php

RUN apt-get install apt-transport-https lsb-release ca-certificates curl -y

RUN apt-get update && apt-get install -y wget nginx php${PHP_VERSION} \
    php${PHP_VERSION}-bcmath php${PHP_VERSION}-bz2 php${PHP_VERSION}-ctype php${PHP_VERSION}-dom php${PHP_VERSION}-fileinfo \
    php${PHP_VERSION}-iconv  php${PHP_VERSION}-simplexml php${PHP_VERSION}-soap php${PHP_VERSION}-sockets php${PHP_VERSION}-tokenizer php${PHP_VERSION}-xmlwriter php${PHP_VERSION}-xsl \
    php${PHP_VERSION}-zip php${PHP_VERSION}-dev php${PHP_VERSION}-imagick php${PHP_VERSION}-tidy php${PHP_VERSION}-xmlrpc \
    php${PHP_VERSION}-fpm php${PHP_VERSION}-common php${PHP_VERSION}-gd php${PHP_VERSION}-cli php${PHP_VERSION}-mbstring php${PHP_VERSION}-intl \
    php${PHP_VERSION}-xml php${PHP_VERSION}-opcache php${PHP_VERSION}-mysql php${PHP_VERSION}-curl php${PHP_VERSION}-redis \
    composer

RUN phpv=`echo ${PHP_VERSION} | sed s/[.]//g` && if test  ${phpv} -ge 72 ; then cd /var/www \
    && wget -c "https://files.phpmyadmin.net/phpMyAdmin/5.2.2/phpMyAdmin-5.2.2-all-languages.tar.gz" \
    && tar -zxvf phpMyAdmin-5.2.2-all-languages.tar.gz && mv phpMyAdmin-5.2.2-all-languages phpmyadmin \
    && rm -rf phpMyAdmin-5.2.2-all-languages.tar.gz; \ 
    else cd /var/www \
    && wget -c "https://files.phpmyadmin.net/phpMyAdmin/4.9.10/phpMyAdmin-4.9.10-all-languages.tar.gz" \
    && tar -zxvf phpMyAdmin-4.9.10-all-languages.tar.gz && mv phpMyAdmin-4.9.10-all-languages phpmyadmin \
    && rm -rf phpMyAdmin-4.9.10-all-languages.tar.gz; \ 
    fi

RUN curl -fsSL https://artifacts.opensearch.org/publickeys/opensearch.pgp | gpg --dearmor -o /etc/apt/trusted.gpg.d/opensearch.gpg
RUN echo "deb https://artifacts.opensearch.org/releases/bundle/opensearch/2.x/apt stable main" | tee /etc/apt/sources.list.d/opensearch-2.x.list
RUN apt-get update 
RUN env OPENSEARCH_INITIAL_ADMIN_PASSWORD=admin@admin apt-get install opensearch 
COPY ./phpmyadmin/config.inc.php /var/www/phpmyadmin/config.inc.php

COPY nginx.conf /etc/nginx/
COPY default.template.conf /etc/nginx/default.template
COPY ./logs/. /var/log/nginx/
COPY ./src/. /var/www/html/
COPY php/pool.d/ /etc/php/${PHP_VERSION}/fpm/pool.d/

RUN sed -i "s/php8.0-fpm.sock/php${PHP_VERSION}-fpm.sock/g" /etc/php/${PHP_VERSION}/fpm/pool.d/www.conf

RUN sed -i "s/php8.0-fpm.sock/php${PHP_VERSION}-fpm.sock/g" /etc/nginx/default.template

RUN sed -i "s/Php8.0/php${PHP_VERSION}/g" /var/www/html/src/views/index.php

EXPOSE 80

CMD ["/bin/sh", "-c", "/etc/init.d/php${PHP_VERSION}-fpm stop && update-rc.d php${PHP_VERSION}-fpm defaults && /etc/init.d/php${PHP_VERSION}-fpm start && envsubst localhost < /etc/nginx/default.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"]
